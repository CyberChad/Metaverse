smem --set learning on
epmem --set trigger output
epmem --set phase output
epmem --set graph-match on
epmem --set learning on
timers --off
chunk never

# Procedural Memory

sp {apply*testing-convert
    (state <s> ^operator <op>)
    (<op> ^name testing-convert)
    (<s> ^convert-result <r>)
    (<s> ^superstate <ss>)
    -->
    (<ss> ^convert-result <r> +)
}

sp {testing*propose*testing-convert
    (state <s> ^name testing)
    (<s> ^superstate <ss>)
    (<ss> ^episode <ep>)
    (<ss> ^size <s*1>)
    (<s*1> ^number <size>)
    -->
    (<s> ^operator <op> +)
    (<s> ^operator <op> =)
    (<op> ^name testing-convert +)
    (<op> ^type convert +)
    (<op> ^number <ep> +)
    (<op> ^places <size> +)
}

sp {apply*testing*next*increment
    (state <s> ^test-mode increment)
    (<s> ^operator <op>)
    (<op> ^name testing)
    (<s> ^episode <ep>)
    (<s> ^epmem <e*1>)
    (<e*1> ^result <r*1>)
    (<r*1> ^graph-match 1)
    -->
    (<s> ^episode <ep> -)
    (<s> ^episode (+ <ep> 1) +)
}

sp {apply*testing*next
    (state <s> ^operator <op>)
    (<op> ^name testing)
    (<s> ^counter <ct>)
    (<s> ^convert-result <r>)
    (<s> ^epmem <epmem>)
    (<epmem> ^result <r*1>)
    (<r*1> ^graph-match 1)
    (<epmem> ^command <cmd>)
    (<cmd> ^query <q>)
    -->
    (<s> ^convert-result <r> -)
    (<s> ^counter <ct> -)
    (<s> ^counter (+ <ct> 1) +)
    (<cmd> ^query <q> -)
}

sp {apply*testing*copy-result*cue
    (state <s> ^operator <op>)
    (<op> ^name testing)
    (<s> ^convert-result <c*1>)
    (<s> ^epmem <e*1>)
    (<e*1> ^command <c*2>)
    (<c*2> ^query <q*1>)
    (<q*1> ^symbolic <s*1>)
    (<s*1> ^converted <c>)
    (<c*1> ^<digit-name> <digit>)
    (<digit> ^cue <digit-cue>)
    -->
    (<c> ^<digit-name> <digit-cue> +)
}

sp {apply*testing*copy-symbolic
    (state <s> ^operator <op>)
    (<op> ^name testing)
    (<s> ^episode <ep>)
    (<s> ^convert-result <r>)
    (<s> ^epmem <e*1>)
    (<e*1> ^command <cmd>)
    -->
    (<cmd> ^query <q> +)
    (<q> ^symbolic <sym> +)
    (<sym> ^episode <ep> +)
    (<sym> ^converted <c> +)
}

sp {count-epmem*propose*testing
    (state <s> ^mode testing)
    (<s> ^name count-epmem)
    (<s> ^counter <ct>)
    (<s> ^max { <> <ct> <m*1> })
    -->
    (<s> ^operator <op> +)
    (<s> ^operator <op> =)
    (<op> ^name testing +)
}

sp {apply*switch*ready
    (state <s> ^mode recording)
    (<s> ^operator <op>)
    (<op> ^name switch)
    (<s> ^symbolic <sym>)
    (<sym> ^episode <old>)
    (<s> ^episode <max>)
    (<s> ^io <i*1>)
    (<i*1> ^output-link <out>)
    (<out> ^record <old>)
    -->
    (<s> ^symbolic <sym> -)
    (<s> ^mode recording -)
    (<s> ^mode testing +)
    (<s> ^counter 1 +)
    (<out> ^record <old> -)
    (write |STORAGE DONE (| <max> | episodes) - READY TO BEGIN QUERY|)
}

sp {apply*switch*ep*single
    (state <s> ^test-mode single)
    (<s> ^mode recording)
    (<s> ^operator <op>)
    (<op> ^name switch)
    (<s> ^test-ep <test-ep>)
    (<s> ^episode <max>)
    -->
    (<s> ^episode <max> -)
    (<s> ^episode <test-ep> +)
}

sp {apply*switch*ep*increment
    (state <s> ^test-mode increment)
    (<s> ^mode recording)
    (<s> ^operator <op>)
    (<op> ^name switch)
    (<s> ^episode <max>)
    -->
    (<s> ^episode <max> -)
    (<s> ^episode 1 +)
}

sp {count-epmem*propose*switch
    (state <s> ^mode recording)
    (<s> ^name count-epmem)
    (<s> ^episode <max>)
    (<s> ^max <max>)
    -->
    (<s> ^operator <op> +)
    (<s> ^operator <op> =)
    (<op> ^name switch +)
}

sp {apply*storing*done
    (state <s> ^mode storing)
    (<s> ^operator <op>)
    (<op> ^name storing)
    -->
    (<s> ^mode storing -)
    (<s> ^mode recording +)
    (<s> ^lti t +)
}

sp {count-epmem*elaborate*storing
    (state <s> ^mode storing)
    (<s> ^name count-epmem)
    (<s> ^digit <d>)
    (<s> ^smem <s*1>)
    (<s*1> ^command <cmd>)
    -->
    (<cmd> ^store <d> +)
}

sp {count-epmem*propose*storing
    (state <s> ^mode storing)
    (<s> ^name count-epmem)
    -->
    (<s> ^operator <op> +)
    (<s> ^operator <op> =)
    (<op> ^name storing +)
}

sp {apply*recording-convert
    (state <s> ^operator <op>)
    (<op> ^name recording-convert)
    (<s> ^convert-result <r>)
    (<s> ^superstate <ss>)
    -->
    (<ss> ^convert-result <r> +)
}

sp {recording*propose*recording-convert
    (state <s> ^name recording)
    (<s> ^superstate <ss>)
    (<ss> ^episode <ep>)
    (<ss> ^size <s*1>)
    (<s*1> ^number <size>)
    -->
    (<s> ^operator <op> +)
    (<s> ^operator <op> =)
    (<op> ^name recording-convert +)
    (<op> ^type convert +)
    (<op> ^number <ep> +)
    (<op> ^places <size> +)
}

sp {apply*recording*done
    (state <s> ^operator <op>)
    (<op> ^name recording)
    (<s> ^symbolic <s*1>)
    (<s*1> ^episode <ep>)
    (<s> ^episode <ep>)
    (<s> ^convert-result <r>)
    (<s> ^io <i*1>)
    (<i*1> ^output-link <out>)
    -->
    (<s> ^episode <ep> -)
    (<s> ^episode (+ <ep> 1) +)
    (<s> ^convert-result <r> -)
    (<out> ^record <ep> +)
}

sp {apply*recording*sym-episode
    (state <s> ^operator <op>)
    (<op> ^name recording)
    (<s> ^symbolic <sym>)
    (<sym> ^converted <c>)
    (<s> ^convert-result <r>)
   -{ (<r> ^<attr> <val>)
      (<c> -^<attr> <val>)}
    (<s> ^episode <ep>)
    -->
    (<sym> ^episode <ep> +)
}

sp {apply*recording*copy-result
    (state <s> ^operator <op>)
    (<op> ^name recording)
    (<s> ^symbolic <s*1>)
    (<s*1> ^converted <c>)
    (<s> ^convert-result <c*1>)
    (<c*1> ^<digit-name> <digit>)
    -->
    (<c> ^<digit-name> <digit> +)
}

sp {apply*recording*copy-symbolic
    (state <s> ^operator <op>)
    (<op> ^name recording)
    (<s> ^episode <ep>)
    (<s> ^convert-result <r>)
    -->
    (<s> ^symbolic <s*1> +)
    (<s*1> ^converted <c> +)
}

sp {apply*recording*clean-old
    (state <s> ^operator <op>)
    (<op> ^name recording)
    (<s> ^symbolic <sym>)
    (<sym> ^episode <ep-old>)
    (<s> ^episode { <> <ep-old> <ep> })
    (<s> ^io <i*1>)
    (<i*1> ^output-link <out>)
    (<out> ^record <ep-old>)
    -->
    (<out> ^record <ep-old> -)
    (<s> ^symbolic <sym> -)
}

sp {count-epmem*propose*recording
    (state <s> ^mode recording)
    (<s> ^name count-epmem)
    (<s> ^episode <ep>)
    (<s> ^max { <> <ep> <m*1> })
    -->
    (<s> ^operator <op> +)
    (<s> ^operator <op> =)
    (<op> ^name recording +)
}

sp {apply*power-next
    (state <s> ^operator <op>)
    (<op> ^name power-next)
    (<s> ^x <x>)
    (<s> ^current <c>)
    (<s> ^result <r>)
    -->
    (<s> ^result <r> -)
    (<s> ^result (* <r> <x>) +)
    (<s> ^current <c> -)
    (<s> ^current (+ <c> 1) +)
}

sp {power*propose*power-next
    (state <s> ^name power)
    (<s> ^y <y*1>)
    (<s> ^current { <> <y*1> <c> })
    -->
    (<s> ^operator <op> +)
    (<s> ^operator <op> =)
    (<op> ^name power-next +)
}

sp {apply*power-init
    (state <s> ^operator <op>)
    (<op> ^name power-init)
    -->
    (<s> ^result 1 +)
    (<s> ^current 0 +)
}

sp {power*propose*power-init
    (state <s> ^name power)
    (<s> -^result <r*1>)
    -->
    (<s> ^operator <op> +)
    (<s> ^operator <op> =)
    (<op> ^name power-init +)
}

sp {apply*power-done
    (state <s> ^operator <op>)
    (<op> ^name power-done)
    (<s> ^result <r>)
    (<s> ^superstate <s*1>)
    (<s*1> ^operator <ss-op>)
    -->
    (<ss-op> ^result <r> +)
}

sp {power*propose*power-done
    (state <s> ^name power)
    (<s> ^y <y>)
    (<s> ^current <y>)
    -->
    (<s> ^operator <op> +)
    (<s> ^operator <op> =)
    (<op> ^name power-done +)
}

sp {power*elaborate*substate
    (state <s> ^superstate <s*1>)
    (<s*1> ^operator <so>)
    (<so> ^type power)
    (<so> ^y <y>)
    (<so> ^x <x>)
    -->
    (<s> ^name power +)
    (<s> ^x <x> +)
    (<s> ^y <y> +)
}

sp {apply*max
    (state <s> ^operator <op>)
    (<op> ^name max)
    (<op> ^result <r>)
    -->
    (<s> ^max <r> +)
}

sp {count-epmem*propose*max
    (state <s> ^name count-epmem)
    (<s> -^max <m*1>)
    (<s> ^size <s*1>)
    (<s*1> ^number <size>)
    -->
    (<s> ^operator <op> +)
    (<s> ^operator <op> =)
    (<op> ^name max +)
    (<op> ^type power +)
    (<op> ^x 10 +)
    (<op> ^y <size> +)
}

sp {apply*initialize-count-epmem
    (state <s> ^operator <op>)
    (<op> ^name initialize-count-epmem)
    -->
    (<s> ^name count-epmem +)
    (<s> ^digit <d0> +)
    (<s> ^digit <d1> +)
    (<s> ^digit <d2> +)
    (<s> ^digit <d3> +)
    (<s> ^digit <d4> +)
    (<s> ^digit <d5> +)
    (<s> ^digit <d6> +)
    (<s> ^digit <d7> +)
    (<s> ^digit <d8> +)
    (<s> ^digit <d9> +)
    (<s> ^episode 1 +)
    (<s> ^mode storing +)
    (<s> ^size <d2> +)
    (<s> ^test-mode increment +)
    (<s> ^test-ep 1 +)
    (<d0> ^word zero +)
    (<d0> ^number 0 +)
    (<d0> ^next <d1> +)
    (<d0> ^previous nil +)
    (<d1> ^word one +)
    (<d1> ^number 1 +)
    (<d1> ^next <d2> +)
    (<d1> ^previous <d0> +)
    (<d2> ^word two +)
    (<d2> ^number 2 +)
    (<d2> ^next <d3> +)
    (<d2> ^previous <d1> +)
    (<d3> ^word three +)
    (<d3> ^number 3 +)
    (<d3> ^next <d4> +)
    (<d3> ^previous <d2> +)
    (<d4> ^word four +)
    (<d4> ^number 4 +)
    (<d4> ^next <d5> +)
    (<d4> ^previous <d3> +)
    (<d5> ^word five +)
    (<d5> ^number 5 +)
    (<d5> ^next <d6> +)
    (<d5> ^previous <d4> +)
    (<d6> ^word six +)
    (<d6> ^number 6 +)
    (<d6> ^next <d7> +)
    (<d6> ^previous <d5> +)
    (<d7> ^word seven +)
    (<d7> ^number 7 +)
    (<d7> ^next <d8> +)
    (<d7> ^previous <d6> +)
    (<d8> ^word eight +)
    (<d8> ^number 8 +)
    (<d8> ^next <d9> +)
    (<d8> ^previous <d7> +)
    (<d9> ^word nine +)
    (<d9> ^number 9 +)
    (<d9> ^next nil +)
    (<d9> ^previous <d8> +)
}

sp {propose*initialize-count-epmem
    (state <s> ^superstate nil)
    (<s> -^name <n*1>)
    -->
    (<s> ^operator <o> +)
    (<o> ^name initialize-count-epmem +)
}

sp {apply*done
    (state <s> ^operator <op>)
    (<op> ^name done)
    -->
    (write |COUNTING TEST SUCCEEDED!|)
    (halt)
}

sp {count-epmem*propose*done
    (state <s> ^mode testing)
    (<s> ^name count-epmem)
    (<s> ^counter <ct>)
    (<s> ^max <ct>)
    -->
    (<s> ^operator <op> +)
    (<s> ^operator <op> =)
    (<op> ^name done +)
}

sp {apply*convert-init
    (state <s> ^operator <op>)
    (<op> ^name convert-init)
    -->
    (<s> ^result <r> +)
    (<s> ^current 0 +)
    (<s> ^pow-ten 10 +)
}

sp {convert*propose*convert-init
    (state <s> ^name convert)
    (<s> -^current <c*1>)
    -->
    (<s> ^operator <op> +)
    (<s> ^operator <op> =)
    (<op> ^name convert-init +)
}

sp {apply*convert-done
    (state <s> ^operator <op>)
    (<op> ^name convert-done)
    (<s> ^result <r>)
    (<s> ^superstate <ss>)
    -->
    (<ss> ^convert-result <r> +)
}

sp {convert*propose*convert-done
    (state <s> ^name convert)
    (<s> ^current <p>)
    (<s> ^places <p>)
    -->
    (<s> ^operator <op> +)
    (<s> ^operator <op> =)
    (<op> ^name convert-done +)
}

sp {apply*convert-digit
    (state <s> ^operator <op>)
    (<op> ^name convert-digit)
    (<s> ^intermediate <i>)
    (<s> ^pow-ten <pow-ten>)
    (<s> ^current <c>)
    (<s> ^top-state <t*1>)
    (<t*1> ^digit <digit-i>)
    (<digit-i> ^number <i>)
    (<t*1> ^digit <digit-c>)
    (<digit-c> ^previous <p*1>)
    (<p*1> ^number <c>)
    (<digit-c> ^word <word-current>)
    (<s> ^result <r>)
    -->
    (<s> ^current <c> -)
    (<s> ^current (+ <c> 1) +)
    (<s> ^pow-ten <pow-ten> -)
    (<s> ^pow-ten (* <pow-ten> 10) +)
    (<s> ^intermediate <i> -)
    (<r> ^<word-current> <digit-i> +)
}

sp {apply*convert-digit*intermediate
    (state <s> ^operator <op>)
    (<op> ^name convert-digit)
    (<s> ^pow-ten <pow-ten>)
    (<s> ^number <n>)
    -->
    (<s> ^intermediate (int (mod (int (* (|/| <n> <pow-ten>) 10)) 10)) +)
}

sp {convert*propose*convert-digit
    (state <s> ^name convert)
    (<s> ^current <c>)
    (<s> ^places { <> <c> <p*1> })
    -->
    (<s> ^operator <op> +)
    (<s> ^operator <op> =)
    (<op> ^name convert-digit +)
}

sp {convert*elaborate*substate
    (state <s> ^superstate <s*1>)
    (<s*1> ^operator <so>)
    (<so> ^type convert)
    (<so> ^places <p>)
    (<so> ^number <n>)
    -->
    (<s> ^name convert +)
    (<s> ^number <n> +)
    (<s> ^places <p> +)
}

sp {elaborate*top-state*top-state
    (state <s> ^superstate nil)
    -->
    (<s> ^top-state <s> +)
}

sp {elaborations*elaborate*state*bad-retrieval*gm
    (state <s> ^epmem <e*1>)
    (<e*1> ^result <r*1>)
    (<r*1> ^graph-match 0)
    -->
    (write |BAD RETRIEVAL!!!|)
    (halt)
}

sp {elaborations*elaborate*state*digit-cue
    (state <s> ^digit <d>)
    (<d> ^number <number>)
    (<d> ^word <word>)
    -->
    (<d> ^cue <c> +)
    (<c> ^word <word> +)
    (<c> ^number <number> +)
}

sp {elaborate*state*top-state
    (state <s> ^superstate <s*1>)
    (<s*1> ^top-state <ts>)
    -->
    (<s> ^top-state <ts> +)
}

sp {elaborate*state*name
    (state <s> ^superstate <s*1>)
    (<s*1> ^operator <o*1>)
    (<o*1> ^name <name>)
    -->
    (<s> ^name <name> +)
}


